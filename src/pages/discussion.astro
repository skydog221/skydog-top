---
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";

const pageTitle = "讨论";
const pageDescription = "在这里与我交流讨论";
---

<MainGridLayout title={pageTitle} description={pageDescription}>
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
        <div class="card-base z-10 px-9 py-6 relative w-full">
            <h1 class="text-3xl font-bold mb-4">欢迎来到讨论区</h1>
            <p class="text-neutral-600 dark:text-neutral-400 mb-6">
                在这里可以自由交流讨论，分享你的想法和建议。
            </p>
            
            <!-- Waline 评论系统容器 -->
            <div id="waline-container" class="mt-8"></div>
        </div>
    </div>
</MainGridLayout>

<script>
    // 全局变量存储实例
    let walineInstance = null;
    let themeObserver = null;

    // 清理函数
    function cleanup() {
        if (walineInstance && walineInstance.destroy) {
            walineInstance.destroy();
            walineInstance = null;
        }
        if (themeObserver) {
            themeObserver.disconnect();
            themeObserver = null;
        }
    }

    // 动态加载 Waline
    function loadWaline() {
        // 清理旧实例
        cleanup();

        // 检查容器是否存在
        const container = document.querySelector('#waline-container');
        if (!container) return;

        // 先加载 Waline CSS
        if (!document.querySelector('link[href*="waline.css"]')) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://unpkg.com/@waline/client@v3/dist/waline.css';
            document.head.appendChild(link);
        }

        // 动态导入 Waline 模块
        //@ts-ignore
        import('https://unpkg.com/@waline/client@v3/dist/waline.js').then((module) => {
            const isDark = document.documentElement.classList.contains('dark');
            
            walineInstance = module.init({
                el: '#waline-container',
                serverURL: 'https://comments.mbod.me/.netlify/functions/comment',
                lang: 'zh-CN',
                locale: {
                    placeholder: '欢迎评论...',
                },
                dark: isDark ? 'auto' : false,
                meta: ['nick', 'mail', 'link'],
                requiredMeta: ['nick'],
                pageSize: 10,
                emoji: [
                    '//unpkg.com/@waline/emojis@1.2.0/weibo',
                    '//unpkg.com/@waline/emojis@1.2.0/bilibili',
                    '//unpkg.com/@waline/emojis@1.2.0/tieba'
                ],
                search: true,
                copyright: true,
                reaction: false,
            });
    
            // 监听主题变化
            setupThemeObserver(walineInstance);
        }).catch((error) => {
            console.error('Failed to load Waline:', error);
        });
    }
    
    // 监听主题变化
    //@ts-ignore
    function setupThemeObserver(walineInstance) {
        themeObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class') {
                    const isDark = document.documentElement.classList.contains('dark');
                    if (walineInstance && walineInstance.update) {
                        walineInstance.update({
                            dark: isDark ? 'auto' : false,
                        });
                    }
                }
            });
        });
    
        themeObserver.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['class']
        });
    }

    // 初始化函数
    function init() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadWaline);
        } else {
            loadWaline();
        }
    }

    // 页面加载完成后初始化
    init();

    // 监听 Astro 页面切换事件
    document.addEventListener('astro:page-load', init);
    
    // 页面切换前清理
    document.addEventListener('astro:before-swap', cleanup);
</script>

<style>
    #waline-container {
        min-height: 200px;
    }
    
    /* Waline 容器样式 */
    :global(#waline-container .wl-container) {
        width: 100%;
    }

    /* 适配深色模式 */
    :global(.dark #waline-container) {
        color-scheme: dark;
    }
</style>